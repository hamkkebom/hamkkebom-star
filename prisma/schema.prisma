generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id              String              @id @default(cuid())
  authId          String              @unique
  email           String              @unique
  name            String
  phone           String?
  avatarUrl       String?
  role            Role                @default(STAR)
  baseRate        Decimal?            @db.Decimal(10, 2)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  chineseName     String?
  externalId      String?             @unique
  isApproved      Boolean             @default(false)
  idNumber        String?
  bankName        String?
  bankAccount     String?
  feedbacks       Feedback[]          @relation("AuthoredFeedbacks")
  portfolio       Portfolio?
  assignments     ProjectAssignment[]
  createdRequests ProjectRequest[]    @relation("CreatedRequests")
  settlementItems SettlementItem[]
  settlements     Settlement[]
  submissions     Submission[]
  videos          Video[]

  // Grade Relation
  gradeId         String?
  grade           PricingGrade?       @relation(fields: [gradeId], references: [id], onDelete: SetNull)

  // Manager Relation (Self-relation)
  managerId       String?
  manager         User?               @relation("ManagerToStar", fields: [managerId], references: [id])
  managedStars    User[]              @relation("ManagerToStar")


  // Reviewed Assignments Relation
  reviewedAssignments ProjectAssignment[] @relation("ReviewedAssignments")
  @@map("users")
}

model ProjectRequest {
  id              String              @id @default(cuid())
  title           String
  categories      String[]
  deadline        DateTime
  assignmentType  AssignmentType      @default(MULTIPLE)
  maxAssignees    Int                 @default(3)
  estimatedBudget Decimal?            @db.Decimal(10, 2)
  requirements    String?
  referenceUrls   String[]
  status          RequestStatus       @default(OPEN)
  createdById     String
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  assignments     ProjectAssignment[]
  createdBy       User                @relation("CreatedRequests", fields: [createdById], references: [id])

  @@map("project_requests")
}

model ProjectAssignment {
  id               String           @id @default(cuid())
  status           AssignmentStatus @default(PENDING_APPROVAL)
  starId           String
  requestId        String
  rejectionReason  String?
  reviewedAt       DateTime?
  reviewedById     String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  request          ProjectRequest   @relation(fields: [requestId], references: [id], onDelete: Cascade)
  reviewedBy       User?            @relation("ReviewedAssignments", fields: [reviewedById], references: [id])
  star             User             @relation(fields: [starId], references: [id])
  submissions Submission[]
  @@map("project_assignments")
}

model Submission {
  id              String             @id @default(cuid())
  versionSlot     Int
  versionTitle    String?
  version         String             @default("1.0")
  status          SubmissionStatus   @default(PENDING)
  streamUid       String?
  r2Key           String?
  duration        Float?
  thumbnailUrl    String?
  starId          String
  assignmentId    String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  approvedAt      DateTime?
  externalId      String?            @unique
  fileUrl         String?
  reviewedAt      DateTime?
  reviewerId      String?
  statusKo        String?
  submittedAt     DateTime?
  summaryFeedback String?
  videoId         String?
  feedbacks       Feedback[]
  settlementItem  SettlementItem?
  aiAnalysis      AiAnalysis?
  assignment      ProjectAssignment? @relation(fields: [assignmentId], references: [id], onDelete: SetNull)
  star            User               @relation(fields: [starId], references: [id])
  video           Video?             @relation(fields: [videoId], references: [id])
  parentId        String?
  parent          Submission?        @relation("SubmissionHistory", fields: [parentId], references: [id])
  children        Submission[]       @relation("SubmissionHistory")

  @@map("submissions")
}

model AiAnalysis {
  id            String   @id @default(cuid())
  submissionId  String   @unique
  summary       String   @default("")
  scores        Json     @default("{}")
  todoItems     Json     @default("[]")
  insights      Json     @default("[]")
  model         String   @default("gemini-2.0-flash")
  status        String   @default("PENDING")
  errorMessage  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  submission    Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@map("ai_analyses")
}

model Feedback {
  id           String           @id @default(cuid())
  type         FeedbackType     @default(GENERAL)
  priority     FeedbackPriority @default(NORMAL)
  status       FeedbackStatus   @default(PENDING)
  content      String
  startTime    Float?
  endTime      Float?
  annotation   Json?
  authorId     String
  submissionId String
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  author       User             @relation("AuthoredFeedbacks", fields: [authorId], references: [id])
  submission   Submission       @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@map("feedbacks")
}

model Video {
  id              String              @id @default(cuid())
  title           String
  description     String?
  categoryId      String?
  status          VideoStatus         @default(DRAFT)
  thumbnailUrl    String?
  streamUid       String?             @unique
  r2Key           String?
  ownerId         String
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  counselorId     String?
  externalId      String?             @unique
  lyrics          String?
  customRate      Decimal?            @db.Decimal(10, 2)
  videoSubject    VideoSubject?
  mediaPlacements MediaPlacement[]
  submissions     Submission[]
  eventLogs       VideoEventLog[]
  technicalSpec   VideoTechnicalSpec?
  category        Category?           @relation(fields: [categoryId], references: [id])
  counselor       Counselor?          @relation(fields: [counselorId], references: [id])
  owner           User                @relation(fields: [ownerId], references: [id])

  @@map("videos")
}

model VideoTechnicalSpec {
  id            String   @id @default(cuid())
  videoId       String   @unique
  filename      String?
  format        String?
  fileSize      BigInt?
  videoCodec    String?
  width         Int?
  height        Int?
  fps           Float?
  aspectRatio   String?
  bitrate       Int?
  duration      Float?
  audioCodec    String?
  audioChannels Int?
  sampleRate    Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  video         Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@map("video_technical_specs")
}

model VideoEventLog {
  id        String   @id @default(cuid())
  videoId   String
  event     String
  fromState String?
  toState   String?
  metadata  Json?
  createdAt DateTime @default(now())
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@map("video_event_logs")
}

model Settlement {
  id          String           @id @default(cuid())
  starId      String
  year        Int
  month       Int
  totalAmount Decimal          @default(0) @db.Decimal(12, 2)
  status      SettlementStatus @default(PENDING)
  note        String?
  paymentDate DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  items       SettlementItem[]
  star        User             @relation(fields: [starId], references: [id])

  @@unique([starId, year, month])
  @@map("settlements")
}

model SettlementItem {
  id             String     @id @default(cuid())
  settlementId   String
  submissionId   String?    @unique
  starId         String
  baseAmount     Decimal    @db.Decimal(10, 2)
  adjustedAmount Decimal?   @db.Decimal(10, 2)
  finalAmount    Decimal    @db.Decimal(10, 2)
  description    String?
  itemType       String     @default("SUBMISSION")
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  settlement     Settlement @relation(fields: [settlementId], references: [id], onDelete: Cascade)
  star           User       @relation(fields: [starId], references: [id])
  submission     Submission? @relation(fields: [submissionId], references: [id])

  @@map("settlement_items")
}

model SystemSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  label     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

model Portfolio {
  id          String          @id @default(cuid())
  userId      String          @unique
  bio         String?
  showreel    String?
  website     String?
  socialLinks Json?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  items       PortfolioItem[]
  user        User            @relation(fields: [userId], references: [id])

  @@map("portfolios")
}

model PortfolioItem {
  id           String    @id @default(cuid())
  portfolioId  String
  title        String
  description  String?
  thumbnailUrl String?
  videoUrl     String?
  sortOrder    Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  portfolio    Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@map("portfolio_items")
}

model Category {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  icon      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  videos    Video[]

  @@map("categories")
}

model Counselor {
  id             String          @id @default(cuid())
  externalId     String?         @unique
  counselorNo    Int?            @unique
  displayName    String
  status         CounselorStatus @default(ACTIVE)
  category       String?
  imageUrl       String?
  landingPageUrl String?
  hashtags       String?
  specialties    String?
  introduction   String?
  announcements  String?
  career         String?
  kokkok         Boolean         @default(false)
  donation       Boolean         @default(false)
  gift           Boolean         @default(false)
  previousRate   Decimal?        @db.Decimal(10, 2)
  targetRate     Decimal?        @db.Decimal(10, 2)
  currentHours   Float?
  targetHours    Float?
  waitTime       Float?
  note           String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  videos         Video[]

  @@map("counselors")
}

model MediaPlacement {
  id            String          @id @default(cuid())
  externalId    String?         @unique
  videoId       String
  medium        String
  placementType String?
  status        PlacementStatus @default(READY)
  campaignName  String?
  channel       String?
  startDate     DateTime?
  endDate       DateTime?
  url           String?
  budget        Decimal?        @db.Decimal(12, 2)
  performance   String?
  note          String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  video         Video           @relation(fields: [videoId], references: [id])

  @@map("media_placements")
}

model PricingGrade {
  id        String   @id @default(cuid())
  name      String   @unique
  baseRate  Decimal  @db.Decimal(10, 2)
  color     String   @default("slate")
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  users     User[]

  @@map("pricing_grades")
}

enum Role {
  ADMIN
  STAR
}

enum RequestStatus {
  OPEN
  FULL
  CLOSED
  CANCELLED
}

enum AssignmentType {
  SINGLE
  MULTIPLE
}

enum AssignmentStatus {
  PENDING_APPROVAL
  ACCEPTED
  IN_PROGRESS
  SUBMITTED
  COMPLETED
  CANCELLED
  REJECTED
}

enum SubmissionStatus {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
  REVISED
}

enum FeedbackType {
  SUBTITLE
  BGM
  CUT_EDIT
  COLOR_GRADE
  GENERAL
}

enum FeedbackPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum FeedbackStatus {
  PENDING
  RESOLVED
  WONTFIX
}

enum VideoStatus {
  DRAFT
  PENDING
  APPROVED
  FINAL
}

enum VideoSubject {
  COUNSELOR
  BRAND
  OTHER
}

enum SettlementStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum CounselorStatus {
  ACTIVE
  INACTIVE
  ON_HOLD
}

enum PlacementStatus {
  READY
  ACTIVE
  COMPLETED
  PAUSED
}
